<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASR è¯­éŸ³è¯†åˆ«æµ‹è¯•ç•Œé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #28a745;
        }

        .status-dot.speaking {
            background: #ffc107;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-row {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover:not(:disabled) {
            background: #e0a800;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .input-group label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .input-group input,
        .input-group select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .result-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .result-panel h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .result-text {
            background: white;
            padding: 20px;
            border-radius: 8px;
            min-height: 100px;
            font-size: 18px;
            color: #333;
            line-height: 1.6;
            border: 2px solid #e0e0e0;
        }

        .result-text.empty {
            color: #999;
            font-style: italic;
        }

        .result-meta {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            font-size: 14px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
        }

        .meta-item strong {
            color: #333;
        }

        .log-panel {
            background: #1e1e1e;
            border-radius: 10px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-panel h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .log-entry {
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry .timestamp {
            color: #888;
            margin-right: 10px;
        }

        .log-entry.info {
            color: #4fc3f7;
        }

        .log-entry.success {
            color: #66bb6a;
        }

        .log-entry.error {
            color: #ef5350;
        }

        .log-entry.warning {
            color: #ffca28;
        }

        .recording-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 8px;
            margin-top: 20px;
        }

        .recording-indicator.active {
            display: flex;
        }

        .recording-dot {
            width: 16px;
            height: 16px;
            background: #dc3545;
            border-radius: 50%;
            animation: recording-pulse 1s infinite;
        }

        @keyframes recording-pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .audio-visualizer {
            width: 100%;
            height: 80px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .audio-visualizer.active {
            display: block;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #28a745;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .feature-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .feature-label {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .feature-label strong {
            color: #333;
            font-size: 16px;
        }

        .feature-label span {
            color: #666;
            font-size: 13px;
        }

        .stats-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .stats-panel h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .stat-label {
            color: #666;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .stat-value {
            color: #333;
            font-size: 24px;
            font-weight: 600;
        }

        .stat-unit {
            color: #999;
            font-size: 14px;
            margin-left: 5px;
        }

        .stat-card.highlight {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%);
        }

        .noise-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .noise-badge.enabled {
            background: #d4edda;
            color: #155724;
        }

        .noise-badge.disabled {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ™ï¸ ASR è¯­éŸ³è¯†åˆ«æµ‹è¯•</h1>
            <p>Java é›†æˆä¸“ç”¨ ASR æœåŠ¡æµ‹è¯•ç•Œé¢</p>
        </div>

        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="connectionStatus"></div>
                <span id="connectionText">æœªè¿æ¥</span>
            </div>
            <div class="status-item">
                <span id="sessionId">ä¼šè¯ID: æ— </span>
            </div>
            <div class="status-item">
                <span id="audioChunks">éŸ³é¢‘å—: 0</span>
            </div>
        </div>

        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('record')">ğŸ¤ å½•éŸ³æµ‹è¯•</button>
            <button class="tab" onclick="switchTab('file')">ğŸ“ æ–‡ä»¶æµ‹è¯•</button>
            <button class="tab" onclick="switchTab('settings')">âš™ï¸ è®¾ç½®</button>
        </div>

        <!-- å½•éŸ³æµ‹è¯•æ ‡ç­¾é¡µ -->
        <div id="recordTab" class="tab-content active">
            <div class="control-panel">
                <div class="input-group">
                    <label>WebSocket åœ°å€</label>
                    <input type="text" id="wsUrl" value="ws://localhost:8767/asr" placeholder="WebSocket åœ°å€">
                </div>

                <div class="control-row">
                    <button class="btn btn-primary" id="connectBtn" onclick="connectToServer()">
                        <span>ğŸ”Œ</span> è¿æ¥æœåŠ¡å™¨
                    </button>
                    <button class="btn btn-danger" id="disconnectBtn" onclick="disconnectFromServer()" disabled>
                        <span>ğŸ”Œ</span> æ–­å¼€è¿æ¥
                    </button>
                </div>

                <div class="control-row">
                    <button class="btn btn-success" id="startRecordBtn" onclick="startRecording()" disabled>
                        <span>ğŸ¤</span> å¼€å§‹å½•éŸ³
                    </button>
                    <button class="btn btn-warning" id="stopRecordBtn" onclick="stopRecording()" disabled>
                        <span>â¹ï¸</span> åœæ­¢å½•éŸ³
                    </button>
                </div>
            </div>

            <div class="recording-indicator" id="recordingIndicator">
                <div class="recording-dot"></div>
                <span>æ­£åœ¨å½•éŸ³ä¸­... ä¿æŒè¯´è¯ï¼Œ2ç§’é™éŸ³åè‡ªåŠ¨è¯†åˆ«</span>
            </div>

            <canvas class="audio-visualizer" id="audioVisualizer"></canvas>
        </div>

        <!-- æ–‡ä»¶æµ‹è¯•æ ‡ç­¾é¡µ -->
        <div id="fileTab" class="tab-content">
            <div class="control-panel">
                <div class="input-group">
                    <label>é€‰æ‹©éŸ³é¢‘æ–‡ä»¶ (WAV, MP3, M4A ç­‰)</label>
                    <input type="file" id="audioFile" accept="audio/*">
                </div>

                <div class="control-row">
                    <button class="btn btn-primary" id="uploadBtn" onclick="uploadAndRecognize()" disabled>
                        <span>ğŸ“¤</span> ä¸Šä¼ å¹¶è¯†åˆ«
                    </button>
                </div>
            </div>
        </div>

        <!-- è®¾ç½®æ ‡ç­¾é¡µ -->
        <div id="settingsTab" class="tab-content">
            <div class="control-panel">
                <!-- é™å™ªåŠŸèƒ½å¼€å…³ -->
                <div class="feature-control">
                    <div class="feature-label">
                        <strong>ğŸ§ é™å™ªåŠŸèƒ½ <span class="noise-badge disabled" id="noiseBadge">æœªå¯ç”¨</span></strong>
                        <span>é€‚ç”¨äºè½¦è¾†ã€é£å£°ã€äººå£°ç­‰å˜ˆæ‚ç¯å¢ƒï¼ˆâš ï¸ éœ€è¦æœåŠ¡å™¨æ”¯æŒï¼‰</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="noiseReductionToggle" onchange="toggleNoiseReduction()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="input-group">
                    <label>è¯­è¨€è®¾ç½®</label>
                    <select id="languageSelect">
                        <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
                        <option value="zh">ä¸­æ–‡</option>
                        <option value="en">è‹±æ–‡</option>
                        <option value="yue">ç²¤è¯­</option>
                        <option value="ja">æ—¥è¯­</option>
                        <option value="ko">éŸ©è¯­</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>ä¼šè¯IDï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="customSessionId" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                </div>

                <div class="input-group">
                    <label>é™éŸ³æ£€æµ‹æ—¶é•¿ï¼ˆç§’ï¼‰</label>
                    <input type="number" id="silenceDuration" value="2" min="1" max="5" step="0.5">
                </div>
            </div>
        </div>

        <!-- æ€§èƒ½ç»Ÿè®¡é¢æ¿ -->
        <div class="stats-panel">
            <h3>ğŸ“Š æ€§èƒ½ç»Ÿè®¡</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">æ€»è¯†åˆ«æ—¶é•¿</div>
                    <div class="stat-value" id="totalDuration">0<span class="stat-unit">ç§’</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å½•éŸ³æ—¶é•¿</div>
                    <div class="stat-value" id="recordingDuration">0<span class="stat-unit">ç§’</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¤„ç†å»¶è¿Ÿ</div>
                    <div class="stat-value" id="processingDelay">0<span class="stat-unit">ms</span></div>
                </div>
                <div class="stat-card highlight">
                    <div class="stat-label">ASR è¯†åˆ«è€—æ—¶</div>
                    <div class="stat-value" id="asrDuration">0<span class="stat-unit">ms</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">éŸ³é¢‘å—æ•°é‡</div>
                    <div class="stat-value" id="totalChunks">0<span class="stat-unit">ä¸ª</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡å»¶è¿Ÿ</div>
                    <div class="stat-value" id="avgLatency">0<span class="stat-unit">ms</span></div>
                </div>
            </div>
        </div>

        <!-- è¯†åˆ«ç»“æœé¢æ¿ -->
        <div class="result-panel">
            <h3>ğŸ“ è¯†åˆ«ç»“æœ</h3>
            <div class="result-text empty" id="resultText">ç­‰å¾…è¯†åˆ«ç»“æœ...</div>
            <div class="result-meta" id="resultMeta" style="display: none;">
                <div class="meta-item">
                    <span>ç½®ä¿¡åº¦:</span>
                    <strong id="confidence">-</strong>
                </div>
                <div class="meta-item">
                    <span>ä¼šè¯ID:</span>
                    <strong id="resultSessionId">-</strong>
                </div>
                <div class="meta-item">
                    <span>æ—¶é—´:</span>
                    <strong id="timestamp">-</strong>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—é¢æ¿ -->
        <div class="log-panel">
            <h3>ğŸ“‹ ç³»ç»Ÿæ—¥å¿—</h3>
            <div id="logContainer"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let ws = null;
        let mediaRecorder = null;
        let audioContext = null;
        let audioStream = null;
        let currentSessionId = null;
        let audioChunkCount = 0;
        let isRecording = false;
        let noiseReductionEnabled = false;

        // ç»Ÿè®¡æ•°æ®
        let stats = {
            recordingStartTime: null,
            recordingEndTime: null,
            firstChunkTime: null,
            lastChunkTime: null,
            resultReceivedTime: null,
            totalChunks: 0,
            latencies: []
        };

        // æ—¥å¿—å‡½æ•°
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // åˆ‡æ¢é™å™ªåŠŸèƒ½
        function toggleNoiseReduction() {
            noiseReductionEnabled = document.getElementById('noiseReductionToggle').checked;
            const badge = document.getElementById('noiseBadge');
            
            if (noiseReductionEnabled) {
                badge.textContent = 'å·²å¯ç”¨';
                badge.classList.remove('disabled');
                badge.classList.add('enabled');
                addLog('ğŸ§ é™å™ªåŠŸèƒ½å·²å¯ç”¨ï¼ˆä¸‹æ¬¡å½•éŸ³ç”Ÿæ•ˆï¼‰', 'success');
            } else {
                badge.textContent = 'æœªå¯ç”¨';
                badge.classList.remove('enabled');
                badge.classList.add('disabled');
                addLog('ğŸ”‡ é™å™ªåŠŸèƒ½å·²ç¦ç”¨', 'warning');
            }
        }

        // é‡ç½®ç»Ÿè®¡æ•°æ®
        function resetStats() {
            stats = {
                recordingStartTime: null,
                recordingEndTime: null,
                firstChunkTime: null,
                lastChunkTime: null,
                resultReceivedTime: null,
                totalChunks: 0,
                latencies: []
            };
            updateStatsDisplay();
        }

        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        function updateStatsDisplay() {
            // æ€»è¯†åˆ«æ—¶é•¿ï¼ˆä»å¼€å§‹å½•éŸ³åˆ°æ”¶åˆ°ç»“æœï¼‰
            if (stats.recordingStartTime && stats.resultReceivedTime) {
                const totalDuration = ((stats.resultReceivedTime - stats.recordingStartTime) / 1000).toFixed(2);
                document.getElementById('totalDuration').innerHTML = `${totalDuration}<span class="stat-unit">ç§’</span>`;
            }

            // å½•éŸ³æ—¶é•¿ï¼ˆä»å¼€å§‹åˆ°åœæ­¢ï¼‰
            if (stats.recordingStartTime && stats.recordingEndTime) {
                const recordingDuration = ((stats.recordingEndTime - stats.recordingStartTime) / 1000).toFixed(2);
                document.getElementById('recordingDuration').innerHTML = `${recordingDuration}<span class="stat-unit">ç§’</span>`;
            }

            // å¤„ç†å»¶è¿Ÿï¼ˆä»æœ€åä¸€ä¸ªéŸ³é¢‘å—åˆ°æ”¶åˆ°ç»“æœï¼‰
            if (stats.lastChunkTime && stats.resultReceivedTime) {
                const processingDelay = (stats.resultReceivedTime - stats.lastChunkTime).toFixed(0);
                document.getElementById('processingDelay').innerHTML = `${processingDelay}<span class="stat-unit">ms</span>`;
            }

            // ASR è¯†åˆ«è€—æ—¶ï¼ˆä¼°ç®—ï¼šä»åœæ­¢å½•éŸ³åˆ°æ”¶åˆ°ç»“æœï¼‰
            if (stats.recordingEndTime && stats.resultReceivedTime) {
                const asrDuration = (stats.resultReceivedTime - stats.recordingEndTime).toFixed(0);
                document.getElementById('asrDuration').innerHTML = `${asrDuration}<span class="stat-unit">ms</span>`;
            }

            // éŸ³é¢‘å—æ•°é‡
            document.getElementById('totalChunks').innerHTML = `${stats.totalChunks}<span class="stat-unit">ä¸ª</span>`;

            // å¹³å‡å»¶è¿Ÿï¼ˆæ¯ä¸ªéŸ³é¢‘å—å‘é€è€—æ—¶ï¼‰
            if (stats.latencies.length > 0) {
                const avgLatency = (stats.latencies.reduce((a, b) => a + b, 0) / stats.latencies.length).toFixed(2);
                document.getElementById('avgLatency').innerHTML = `${avgLatency}<span class="stat-unit">ms</span>`;
            }
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾
            if (tabName === 'record') {
                document.getElementById('recordTab').classList.add('active');
                document.querySelectorAll('.tab')[0].classList.add('active');
            } else if (tabName === 'file') {
                document.getElementById('fileTab').classList.add('active');
                document.querySelectorAll('.tab')[1].classList.add('active');
            } else if (tabName === 'settings') {
                document.getElementById('settingsTab').classList.add('active');
                document.querySelectorAll('.tab')[2].classList.add('active');
            }
        }

        // è¿æ¥åˆ°æœåŠ¡å™¨
        function connectToServer() {
            const wsUrl = document.getElementById('wsUrl').value;
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                addLog('å·²ç»è¿æ¥åˆ°æœåŠ¡å™¨', 'warning');
                return;
            }

            addLog(`æ­£åœ¨è¿æ¥åˆ° ${wsUrl}...`, 'info');

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    addLog('âœ… WebSocket è¿æ¥æˆåŠŸ', 'success');
                    document.getElementById('connectionStatus').classList.add('connected');
                    document.getElementById('connectionText').textContent = 'å·²è¿æ¥';
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    document.getElementById('startRecordBtn').disabled = false;
                    document.getElementById('uploadBtn').disabled = false;
                };

                ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        handleServerMessage(message);
                    } catch (error) {
                        addLog(`è§£ææ¶ˆæ¯å¤±è´¥: ${error.message}`, 'error');
                    }
                };

                ws.onerror = (error) => {
                    addLog('âŒ WebSocket è¿æ¥é”™è¯¯', 'error');
                    console.error('WebSocket error:', error);
                };

                ws.onclose = () => {
                    addLog('ğŸ”Œ WebSocket è¿æ¥å·²å…³é—­', 'warning');
                    document.getElementById('connectionStatus').classList.remove('connected');
                    document.getElementById('connectionText').textContent = 'æœªè¿æ¥';
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                    document.getElementById('startRecordBtn').disabled = true;
                    document.getElementById('stopRecordBtn').disabled = true;
                    document.getElementById('uploadBtn').disabled = true;
                };

            } catch (error) {
                addLog(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ–­å¼€è¿æ¥
        function disconnectFromServer() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // å¤„ç†æœåŠ¡å™¨æ¶ˆæ¯
        function handleServerMessage(message) {
            const type = message.type;
            addLog(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${type}`, 'info');

            switch (type) {
                case 'welcome':
                    addLog(`æœåŠ¡å™¨ä¿¡æ¯: ${message.message}`, 'success');
                    addLog(`å®¢æˆ·ç«¯ID: ${message.client_id}`, 'info');
                    break;

                case 'session_started':
                    currentSessionId = message.session_id;
                    document.getElementById('sessionId').textContent = `ä¼šè¯ID: ${currentSessionId}`;
                    addLog(`âœ… ä¼šè¯å·²å¼€å§‹: ${currentSessionId}`, 'success');
                    break;

                case 'recognition_result':
                    handleRecognitionResult(message);
                    break;

                case 'session_ended':
                    addLog(`âœ… ä¼šè¯å·²ç»“æŸ`, 'success');
                    currentSessionId = null;
                    document.getElementById('sessionId').textContent = 'ä¼šè¯ID: æ— ';
                    break;

                case 'error':
                    addLog(`âŒ é”™è¯¯: ${message.message}`, 'error');
                    break;

                default:
                    console.log('æœªå¤„ç†çš„æ¶ˆæ¯ç±»å‹:', message);
            }
        }

        // å¤„ç†è¯†åˆ«ç»“æœ
        function handleRecognitionResult(message) {
            const result = message.result;
            const transcription = result.transcription;
            const confidence = result.confidence;
            const isFinal = result.is_final;

            if (isFinal && transcription) {
                // è®°å½•æ”¶åˆ°ç»“æœçš„æ—¶é—´
                stats.resultReceivedTime = Date.now();
                
                // è®¡ç®— ASR è¯†åˆ«è€—æ—¶
                const asrDuration = stats.recordingEndTime ? 
                    (stats.resultReceivedTime - stats.recordingEndTime) : 0;
                
                addLog(`ğŸ¯ æœ€ç»ˆè¯†åˆ«ç»“æœ: ${transcription}`, 'success');
                addLog(`â±ï¸ ASR è¯†åˆ«è€—æ—¶: ${asrDuration}ms`, 'info');
                
                // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
                updateStatsDisplay();
                
                // æ˜¾ç¤ºç»“æœ
                const resultText = document.getElementById('resultText');
                resultText.textContent = transcription;
                resultText.classList.remove('empty');

                // æ˜¾ç¤ºå…ƒæ•°æ®
                document.getElementById('resultMeta').style.display = 'flex';
                document.getElementById('confidence').textContent = (confidence * 100).toFixed(1) + '%';
                document.getElementById('resultSessionId').textContent = message.session_id;
                document.getElementById('timestamp').textContent = new Date(message.timestamp).toLocaleString();
            }
        }

        // å¼€å§‹å½•éŸ³
        async function startRecording() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addLog('âŒ è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨', 'error');
                return;
            }

            try {
                // é‡ç½®ç»Ÿè®¡æ•°æ®
                resetStats();
                stats.recordingStartTime = Date.now();
                
                // è·å–éº¦å…‹é£æƒé™
                audioStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        channelCount: 1,
                        sampleRate: 16000,
                        echoCancellation: true,
                        noiseSuppression: noiseReductionEnabled  // ä½¿ç”¨é™å™ªè®¾ç½®
                    } 
                });

                addLog('ğŸ¤ å·²è·å–éº¦å…‹é£æƒé™', 'success');
                if (noiseReductionEnabled) {
                    addLog('ğŸ§ æµè§ˆå™¨é™å™ªå·²å¯ç”¨', 'info');
                }

                // å‘é€ start_session æ¶ˆæ¯
                const language = document.getElementById('languageSelect').value;
                const customSessionId = document.getElementById('customSessionId').value;
                const sessionId = customSessionId || `web_session_${Date.now()}`;

                const startMessage = {
                    type: 'start_session',
                    language: language,
                    session_id: sessionId
                };

                ws.send(JSON.stringify(startMessage));
                addLog(`ğŸ“¤ å‘é€ start_session æ¶ˆæ¯`, 'info');

                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                const source = audioContext.createMediaStreamSource(audioStream);
                
                // åˆ›å»ºå¤„ç†èŠ‚ç‚¹
                const processor = audioContext.createScriptProcessor(4096, 1, 1);
                
                processor.onaudioprocess = (e) => {
                    if (!isRecording) return;
                    
                    const inputData = e.inputBuffer.getChannelData(0);
                    const pcmData = new Int16Array(inputData.length);
                    
                    // è½¬æ¢ä¸º 16ä½ PCM
                    for (let i = 0; i < inputData.length; i++) {
                        const s = Math.max(-1, Math.min(1, inputData[i]));
                        pcmData[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                    }
                    
                    // Base64 ç¼–ç 
                    const audioData = btoa(String.fromCharCode.apply(null, new Uint8Array(pcmData.buffer)));
                    
                    // å‘é€éŸ³é¢‘æ•°æ®
                    const sendTime = Date.now();
                    const audioMessage = {
                        type: 'audio_chunk',
                        session_id: currentSessionId,
                        audio_data: audioData
                    };
                    
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify(audioMessage));
                        audioChunkCount++;
                        stats.totalChunks++;
                        
                        // è®°å½•ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªéŸ³é¢‘å—çš„æ—¶é—´
                        if (!stats.firstChunkTime) {
                            stats.firstChunkTime = sendTime;
                        }
                        stats.lastChunkTime = sendTime;
                        
                        document.getElementById('audioChunks').textContent = `éŸ³é¢‘å—: ${audioChunkCount}`;
                        
                        // è®°å½•å‘é€å»¶è¿Ÿ
                        const sendDelay = Date.now() - sendTime;
                        stats.latencies.push(sendDelay);
                    }
                };
                
                source.connect(processor);
                processor.connect(audioContext.destination);

                isRecording = true;
                audioChunkCount = 0;

                // æ›´æ–°UI
                document.getElementById('startRecordBtn').disabled = true;
                document.getElementById('stopRecordBtn').disabled = false;
                document.getElementById('recordingIndicator').classList.add('active');
                document.getElementById('connectionStatus').classList.add('speaking');
                
                addLog('ğŸ™ï¸ å¼€å§‹å½•éŸ³ï¼Œè¯·è¯´è¯...', 'success');

            } catch (error) {
                addLog(`âŒ å½•éŸ³å¤±è´¥: ${error.message}`, 'error');
                console.error('Recording error:', error);
            }
        }

        // åœæ­¢å½•éŸ³
        function stopRecording() {
            isRecording = false;
            
            // è®°å½•å½•éŸ³ç»“æŸæ—¶é—´
            stats.recordingEndTime = Date.now();
            
            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            updateStatsDisplay();

            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }

            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            // å‘é€ end_session æ¶ˆæ¯
            if (ws && ws.readyState === WebSocket.OPEN) {
                const endMessage = {
                    type: 'end_session'
                };
                ws.send(JSON.stringify(endMessage));
                addLog('ğŸ“¤ å‘é€ end_session æ¶ˆæ¯', 'info');
                addLog('â³ ç­‰å¾… ASR è¯†åˆ«ç»“æœ...', 'info');
            }

            // æ›´æ–°UI
            document.getElementById('startRecordBtn').disabled = false;
            document.getElementById('stopRecordBtn').disabled = true;
            document.getElementById('recordingIndicator').classList.remove('active');
            document.getElementById('connectionStatus').classList.remove('speaking');

            addLog('â¹ï¸ å½•éŸ³å·²åœæ­¢', 'warning');
        }

        // æ–‡ä»¶ä¸Šä¼ è¯†åˆ«ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function uploadAndRecognize() {
            addLog('âš ï¸ æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½éœ€è¦å•ç‹¬å®ç°ï¼Œå»ºè®®ä½¿ç”¨å½•éŸ³åŠŸèƒ½æµ‹è¯•', 'warning');
            alert('æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½æš‚æœªå®ç°ï¼Œè¯·ä½¿ç”¨å½•éŸ³åŠŸèƒ½è¿›è¡Œæµ‹è¯•');
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = () => {
            addLog('ğŸš€ ASR æµ‹è¯•ç•Œé¢åŠ è½½å®Œæˆ', 'success');
            addLog('ğŸ’¡ è¯·å…ˆç‚¹å‡»"è¿æ¥æœåŠ¡å™¨"æŒ‰é’®', 'info');
        };

        // é¡µé¢å…³é—­æ—¶æ¸…ç†
        window.onbeforeunload = () => {
            if (isRecording) {
                stopRecording();
            }
            if (ws) {
                ws.close();
            }
        };
    </script>
</body>
</html>

