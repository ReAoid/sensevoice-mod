# SenseVoice + 3D-Speaker é›†æˆç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ“– ç›®å½•

- [ç³»ç»Ÿç®€ä»‹](#ç³»ç»Ÿç®€ä»‹)
- [åŠŸèƒ½ç‰¹æ€§](#åŠŸèƒ½ç‰¹æ€§)
- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [ç¯å¢ƒå®‰è£…](#ç¯å¢ƒå®‰è£…)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [è¯¦ç»†ä½¿ç”¨æ•™ç¨‹](#è¯¦ç»†ä½¿ç”¨æ•™ç¨‹)
  - [1. å£°çº¹æ³¨å†Œ](#1-å£°çº¹æ³¨å†Œ)
  - [2. è¯­éŸ³è¯†åˆ«](#2-è¯­éŸ³è¯†åˆ«)
  - [3. è¯´è¯äººè¯†åˆ«](#3-è¯´è¯äººè¯†åˆ«)
  - [4. åˆ‡æ¢åŠŸèƒ½å¼€å…³](#4-åˆ‡æ¢åŠŸèƒ½å¼€å…³)
- [å‘½ä»¤è¡Œä½¿ç”¨](#å‘½ä»¤è¡Œä½¿ç”¨)
- [Web UIä½¿ç”¨](#web-uiä½¿ç”¨)
- [é…ç½®æ–‡ä»¶è¯´æ˜](#é…ç½®æ–‡ä»¶è¯´æ˜)
- [APIæ¥å£](#apiæ¥å£)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
- [æŠ€æœ¯ç»†èŠ‚](#æŠ€æœ¯ç»†èŠ‚)

---

## ç³»ç»Ÿç®€ä»‹

æœ¬ç³»ç»Ÿå°† **3D-Speakerï¼ˆè¯´è¯äººè¯†åˆ«ï¼‰** å’Œ **SenseVoiceï¼ˆè¯­éŸ³è¯†åˆ«ï¼‰** ä¸¤ä¸ªå¼ºå¤§çš„æ¨¡å‹é›†æˆåœ¨ä¸€èµ·ï¼Œæä¾›å®Œæ•´çš„è¯­éŸ³ç†è§£è§£å†³æ–¹æ¡ˆã€‚

### æ ¸å¿ƒèƒ½åŠ›

- ğŸ¯ **å¤šè¯­è¨€è¯­éŸ³è¯†åˆ«**ï¼šæ”¯æŒä¸­æ–‡ã€è‹±æ–‡ã€ç²¤è¯­ã€æ—¥è¯­ã€éŸ©è¯­
- ğŸ˜Š **æƒ…æ„Ÿè¯†åˆ«**ï¼šè¯†åˆ«7ç§æƒ…ç»ªï¼ˆå¼€å¿ƒã€æ‚²ä¼¤ã€æ„¤æ€’ã€ä¸­æ€§ã€å®³æ€•ã€åŒæ¶ã€æƒŠè®¶ï¼‰
- ğŸµ **äº‹ä»¶æ£€æµ‹**ï¼šæ£€æµ‹éŸ³ä¹ã€æŒå£°ã€ç¬‘å£°ã€å“­å£°ã€å’³å—½ç­‰å£°éŸ³äº‹ä»¶
- ğŸ‘¤ **è¯´è¯äººè¯†åˆ«**ï¼šè¯†åˆ«å’ŒéªŒè¯è¯´è¯äººèº«ä»½
- ğŸ”„ **çµæ´»åˆ‡æ¢**ï¼šå¯ä»¥ç‹¬ç«‹ä½¿ç”¨æˆ–ç»„åˆä½¿ç”¨å„é¡¹åŠŸèƒ½

---

## åŠŸèƒ½ç‰¹æ€§

### âœ¨ SenseVoice åŠŸèƒ½

| åŠŸèƒ½ | æè¿° | æ”¯æŒè¯­è¨€ |
|------|------|---------|
| **è¯­éŸ³è¯†åˆ«** | é«˜ç²¾åº¦å¤šè¯­è¨€ASR | ä¸­ã€è‹±ã€ç²¤ã€æ—¥ã€éŸ© |
| **æƒ…æ„Ÿè¯†åˆ«** | 7ç§æƒ…ç»ªåˆ†ç±» | æ‰€æœ‰è¯­è¨€ |
| **äº‹ä»¶æ£€æµ‹** | 8ç§å¸¸è§å£°éŸ³äº‹ä»¶ | æ‰€æœ‰è¯­è¨€ |
| **æ–‡æœ¬è§„èŒƒåŒ–** | è‡ªåŠ¨æ·»åŠ æ ‡ç‚¹ç¬¦å· | ä¸­ã€è‹± |
| **ä½å»¶è¿Ÿ** | 10séŸ³é¢‘ä»…éœ€70ms | - |

### ğŸ™ï¸ 3D-Speaker åŠŸèƒ½

| åŠŸèƒ½ | æè¿° | æ¨¡å‹é€‰æ‹© |
|------|------|---------|
| **å£°çº¹æ³¨å†Œ** | æ³¨å†Œè¯´è¯äººå£°çº¹ç‰¹å¾ | CAM++, ERes2Net, ERes2NetV2 |
| **è¯´è¯äººè¯†åˆ«** | è¯†åˆ«å·²æ³¨å†Œçš„è¯´è¯äºº | åŒä¸Š |
| **ç›¸ä¼¼åº¦è®¡ç®—** | è®¡ç®—å£°çº¹ç›¸ä¼¼åº¦ | åŒä¸Š |
| **æ‰¹é‡æ³¨å†Œ** | æ‰¹é‡æ³¨å†Œå¤šä¸ªè¯´è¯äºº | åŒä¸Š |

---

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é›†æˆASRç³»ç»Ÿ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  3D-Speaker    â”‚         â”‚   SenseVoice     â”‚        â”‚
â”‚  â”‚  è¯´è¯äººè¯†åˆ«     â”‚         â”‚   è¯­éŸ³è¯†åˆ«        â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚ â€¢ å£°çº¹æå–      â”‚         â”‚ â€¢ å¤šè¯­è¨€ASR       â”‚        â”‚
â”‚  â”‚ â€¢ ç‰¹å¾åŒ¹é…      â”‚         â”‚ â€¢ æƒ…æ„Ÿè¯†åˆ«        â”‚        â”‚
â”‚  â”‚ â€¢ èº«ä»½éªŒè¯      â”‚         â”‚ â€¢ äº‹ä»¶æ£€æµ‹        â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚           â†“                          â†“                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚          ç»Ÿä¸€å¤„ç†æµç¨‹                      â”‚            â”‚
â”‚  â”‚  1. éŸ³é¢‘è¾“å…¥                               â”‚            â”‚
â”‚  â”‚  2. è¯´è¯äººè¯†åˆ« (å¯é€‰)                       â”‚            â”‚
â”‚  â”‚  3. è¯­éŸ³è¯†åˆ«                               â”‚            â”‚
â”‚  â”‚  4. ç»“æœè¾“å‡º                               â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç¯å¢ƒå®‰è£…

### ç³»ç»Ÿè¦æ±‚

- Python >= 3.8
- CUDA >= 11.0 (æ¨èï¼Œç”¨äºGPUåŠ é€Ÿ)
- 8GB+ RAM (CPUæ¨¡å¼)
- 4GB+ GPUæ˜¾å­˜ (GPUæ¨¡å¼)

### å®‰è£…æ­¥éª¤

#### 1. å…‹éš†é¡¹ç›®

```bash
cd /Users/mingy/Documents/python/SenseVoice
```

#### 2. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

å¦‚æœç¼ºå°‘æŸäº›ä¾èµ–ï¼Œæ‰‹åŠ¨å®‰è£…ï¼š

```bash
pip install torch torchaudio
pip install modelscope funasr gradio
pip install pyyaml numpy scipy scikit-learn
pip install soundfile librosa
```

#### 3. éªŒè¯å®‰è£…

```bash
# æµ‹è¯•SenseVoice
python -c "from funasr import AutoModel; print('SenseVoice OK')"

# æµ‹è¯•3D-Speaker
python -c "from speakerlab.utils.builder import dynamic_import; print('3D-Speaker OK')"
```

---

## å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šWeb UIï¼ˆæ¨èæ–°æ‰‹ï¼‰

```bash
# å¯åŠ¨Webç•Œé¢
python webui_integrated.py
```

æµè§ˆå™¨æ‰“å¼€ http://localhost:7860

### æ–¹å¼äºŒï¼šå‘½ä»¤è¡Œ

#### åŸºç¡€è¯­éŸ³è¯†åˆ«ï¼ˆä¸ä½¿ç”¨è¯´è¯äººè¯†åˆ«ï¼‰

```bash
python integrated_asr.py --audio test.wav
```

#### å¯ç”¨è¯´è¯äººè¯†åˆ«

```bash
python integrated_asr.py --audio test.wav --enable-speaker
```

### æ–¹å¼ä¸‰ï¼šPython API

```python
from integrated_asr import IntegratedASRSystem

# åˆ›å»ºç³»ç»Ÿ
system = IntegratedASRSystem(enable_speaker_verification=False)

# å¤„ç†éŸ³é¢‘
result = system.process_audio("test.wav", language="auto")
print(result['asr_results'][0]['text'])
```

---

## è¯¦ç»†ä½¿ç”¨æ•™ç¨‹

### 1. å£°çº¹æ³¨å†Œ

#### 1.1 ä¸ºä»€ä¹ˆè¦æ³¨å†Œå£°çº¹ï¼Ÿ

åœ¨ä½¿ç”¨è¯´è¯äººè¯†åˆ«åŠŸèƒ½ä¹‹å‰ï¼Œéœ€è¦å…ˆæ³¨å†Œè¯´è¯äººçš„å£°çº¹ç‰¹å¾ã€‚ç³»ç»Ÿä¼šæå–éŸ³é¢‘ä¸­çš„å£°çº¹ç‰¹å¾å¹¶ä¿å­˜åˆ°å£°çº¹åº“ä¸­ã€‚

#### 1.2 æ³¨å†Œå•ä¸ªå£°çº¹

**å‘½ä»¤è¡Œæ–¹å¼ï¼š**

```bash
python register_voiceprint.py \
  --action register \
  --speaker-id user001 \
  --speaker-name "å¼ ä¸‰" \
  --audio voice_samples/zhangsan.wav
```

**å‚æ•°è¯´æ˜ï¼š**
- `--speaker-id`: è¯´è¯äººå”¯ä¸€IDï¼ˆå¿…éœ€ï¼Œä¸å¯é‡å¤ï¼‰
- `--speaker-name`: è¯´è¯äººåç§°ï¼ˆå¯é€‰ï¼Œä¾¿äºè¯†åˆ«ï¼‰
- `--audio`: éŸ³é¢‘æ–‡ä»¶è·¯å¾„ï¼ˆå»ºè®®3-10ç§’çº¯å‡€äººå£°ï¼‰

**Web UIæ–¹å¼ï¼š**

1. æ‰“å¼€Webç•Œé¢
2. åˆ‡æ¢åˆ°"å£°çº¹ç®¡ç†"æ ‡ç­¾é¡µ
3. å¡«å†™è¯´è¯äººIDå’Œåç§°
4. ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶
5. ç‚¹å‡»"æ³¨å†Œå£°çº¹"æŒ‰é’®
6. ç­‰å¾…æ³¨å†Œå®Œæˆ

#### 1.3 æ‰¹é‡æ³¨å†Œå£°çº¹

å¦‚æœæœ‰å¤šä¸ªéŸ³é¢‘æ–‡ä»¶éœ€è¦æ³¨å†Œï¼š

```bash
# å‡†å¤‡ç›®å½•ç»“æ„
voice_samples/
  â”œâ”€â”€ zhangsan.wav
  â”œâ”€â”€ lisi.wav
  â””â”€â”€ wangwu.wav

# æ‰¹é‡æ³¨å†Œï¼ˆæ–‡ä»¶åä½œä¸ºspeaker_idï¼‰
python register_voiceprint.py \
  --action batch-register \
  --audio-dir voice_samples \
  --pattern "*.wav"
```

#### 1.4 æ³¨å†Œæœ€ä½³å®è·µ

âœ… **æ¨èåšæ³•ï¼š**
- ä½¿ç”¨3-10ç§’çš„çº¯å‡€äººå£°
- åœ¨å®‰é™ç¯å¢ƒå½•åˆ¶
- åŒ…å«è‡ªç„¶çš„è¯­è°ƒå˜åŒ–
- WAVæˆ–MP3æ ¼å¼ï¼Œ16kHzé‡‡æ ·ç‡

âŒ **é¿å…ï¼š**
- éŸ³é¢‘å¤ªçŸ­ï¼ˆ<2ç§’ï¼‰
- èƒŒæ™¯å™ªéŸ³å¤ªå¤§
- éŸ³é‡å¤ªå°æˆ–å¤±çœŸ
- å¤šäººåŒæ—¶è¯´è¯

#### 1.5 æŸ¥çœ‹å·²æ³¨å†Œçš„å£°çº¹

```bash
# åˆ—å‡ºæ‰€æœ‰å·²æ³¨å†Œçš„å£°çº¹
python register_voiceprint.py --action list
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
============================================================
è¯´è¯äººID: user001
è¯´è¯äººåç§°: å¼ ä¸‰
éŸ³é¢‘æ–‡ä»¶: voice_samples/zhangsan.wav
æ³¨å†Œæ—¶é—´: 2024-10-30T10:30:00
æ¨¡å‹ç±»å‹: eres2net

============================================================
è¯´è¯äººID: user002
è¯´è¯äººåç§°: æå››
éŸ³é¢‘æ–‡ä»¶: voice_samples/lisi.wav
æ³¨å†Œæ—¶é—´: 2024-10-30T10:35:00
æ¨¡å‹ç±»å‹: eres2net

============================================================
[INFO] å…±æœ‰ 2 ä¸ªå·²æ³¨å†Œçš„è¯´è¯äºº
```

#### 1.6 åˆ é™¤å£°çº¹

```bash
python register_voiceprint.py \
  --action unregister \
  --speaker-id user001
```

---

### 2. è¯­éŸ³è¯†åˆ«

#### 2.1 åŸºç¡€è¯­éŸ³è¯†åˆ«ï¼ˆä¸ä½¿ç”¨è¯´è¯äººè¯†åˆ«ï¼‰

**å‘½ä»¤è¡Œï¼š**

```bash
python integrated_asr.py --audio test.wav
```

**Python APIï¼š**

```python
from integrated_asr import IntegratedASRSystem

# åˆ›å»ºç³»ç»Ÿï¼ˆå…³é—­è¯´è¯äººè¯†åˆ«ï¼‰
system = IntegratedASRSystem(enable_speaker_verification=False)

# è¯†åˆ«
result = system.process_audio("test.wav", language="auto")

# æŸ¥çœ‹ç»“æœ
for item in result['asr_results']:
    print(item['text'])
```

#### 2.2 æŒ‡å®šè¯­è¨€è¯†åˆ«

```bash
# ä¸­æ–‡
python integrated_asr.py --audio test.wav --language zh

# è‹±æ–‡
python integrated_asr.py --audio test.wav --language en

# ç²¤è¯­
python integrated_asr.py --audio test.wav --language yue
```

æ”¯æŒçš„è¯­è¨€ï¼š`auto`, `zh`, `en`, `yue`, `ja`, `ko`

#### 2.3 æ‰¹é‡å¤„ç†å¤šä¸ªæ–‡ä»¶

```bash
python integrated_asr.py \
  --audio-list file1.wav file2.wav file3.wav \
  --output results.json
```

ç»“æœä¼šä¿å­˜åˆ° `results.json` æ–‡ä»¶ä¸­ã€‚

#### 2.4 è¯†åˆ«ç»“æœè§£æ

è¯†åˆ«ç»“æœåŒ…å«ï¼š
- **æ–‡æœ¬å†…å®¹**ï¼šè¯†åˆ«çš„æ–‡å­—
- **æƒ…æ„Ÿæ ‡ç­¾**ï¼šğŸ˜ŠğŸ˜”ğŸ˜¡ç­‰è¡¨æƒ…
- **äº‹ä»¶æ ‡ç­¾**ï¼šğŸ¼ğŸ‘ğŸ˜€ç­‰äº‹ä»¶

ç¤ºä¾‹è¾“å‡ºï¼š
```
ğŸ¼å¾ˆé«˜å…´è®¤è¯†ä½ ğŸ˜Š
ğŸ‘å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å¼ ä¸‰
è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•éŸ³é¢‘ğŸ˜”
```

---

### 3. è¯´è¯äººè¯†åˆ«

#### 3.1 è¯†åˆ«å·²æ³¨å†Œçš„è¯´è¯äºº

**å‰ææ¡ä»¶ï¼š** å·²ç»æ³¨å†Œäº†è‡³å°‘ä¸€ä¸ªè¯´è¯äººçš„å£°çº¹

**å‘½ä»¤è¡Œï¼š**

```bash
python integrated_asr.py \
  --audio test.wav \
  --enable-speaker
```

**Python APIï¼š**

```python
from integrated_asr import IntegratedASRSystem

# åˆ›å»ºç³»ç»Ÿï¼ˆå¯ç”¨è¯´è¯äººè¯†åˆ«ï¼‰
system = IntegratedASRSystem(enable_speaker_verification=True)

# å¤„ç†éŸ³é¢‘
result = system.process_audio("test.wav")

# æŸ¥çœ‹è¯´è¯äººä¿¡æ¯
if result['speaker_info']:
    print(f"è¯´è¯äºº: {result['speaker_info']['speaker_name']}")
    print(f"ç›¸ä¼¼åº¦: {result['speaker_info']['similarity']:.4f}")
else:
    print("æœªè¯†åˆ«åˆ°æ³¨å†Œçš„è¯´è¯äºº")

# æŸ¥çœ‹è¯†åˆ«æ–‡æœ¬
for item in result['asr_results']:
    print(item['text'])
```

#### 3.2 è°ƒæ•´è¯†åˆ«é˜ˆå€¼

è¯†åˆ«é˜ˆå€¼å†³å®šäº†å¤šç›¸ä¼¼æ‰ç®—åŒ¹é…æˆåŠŸã€‚é˜ˆå€¼èŒƒå›´ï¼š0-1

- **0.3-0.4**ï¼šå®½æ¾ï¼Œå®¹æ˜“åŒ¹é…ï¼Œå¯èƒ½è¯¯è¯†åˆ«
- **0.5-0.6**ï¼šé€‚ä¸­ï¼ˆé»˜è®¤0.5ï¼‰
- **0.7-0.9**ï¼šä¸¥æ ¼ï¼Œä¸æ˜“åŒ¹é…ï¼Œæ›´å‡†ç¡®

**å‘½ä»¤è¡Œè°ƒæ•´ï¼š**

```bash
python integrated_asr.py \
  --audio test.wav \
  --enable-speaker \
  --speaker-threshold 0.7
```

**é…ç½®æ–‡ä»¶è°ƒæ•´ï¼š**

ç¼–è¾‘ `config_3dspeaker.yaml`ï¼š

```yaml
speaker_verification:
  threshold: 0.7  # ä¿®æ”¹è¿™é‡Œ
```

#### 3.3 è¯†åˆ«æµç¨‹è¯¦è§£

```
è¾“å…¥éŸ³é¢‘ â†’ æå–å£°çº¹ç‰¹å¾ â†’ ä¸åº“ä¸­æ‰€æœ‰å£°çº¹å¯¹æ¯” â†’ è®¡ç®—ç›¸ä¼¼åº¦ â†’ åˆ¤æ–­æ˜¯å¦è¶…è¿‡é˜ˆå€¼
```

å¦‚æœæœ€é«˜ç›¸ä¼¼åº¦ >= é˜ˆå€¼ï¼Œè¿”å›åŒ¹é…çš„è¯´è¯äººä¿¡æ¯ï¼Œå¦åˆ™è¿”å› Noneã€‚

---

### 4. åˆ‡æ¢åŠŸèƒ½å¼€å…³

#### 4.1 åŠ¨æ€å¯ç”¨/ç¦ç”¨è¯´è¯äººè¯†åˆ«

**Python APIï¼š**

```python
from integrated_asr import IntegratedASRSystem

# åˆ›å»ºç³»ç»Ÿ
system = IntegratedASRSystem(enable_speaker_verification=False)

# å¤„ç†ç¬¬ä¸€ä¸ªéŸ³é¢‘ï¼ˆä¸è¯†åˆ«è¯´è¯äººï¼‰
result1 = system.process_audio("test1.wav")

# å¯ç”¨è¯´è¯äººè¯†åˆ«
system.toggle_speaker_verification(True)

# å¤„ç†ç¬¬äºŒä¸ªéŸ³é¢‘ï¼ˆè¯†åˆ«è¯´è¯äººï¼‰
result2 = system.process_audio("test2.wav")

# ç¦ç”¨è¯´è¯äººè¯†åˆ«
system.toggle_speaker_verification(False)

# å¤„ç†ç¬¬ä¸‰ä¸ªéŸ³é¢‘ï¼ˆä¸è¯†åˆ«è¯´è¯äººï¼‰
result3 = system.process_audio("test3.wav")
```

#### 4.2 é…ç½®æ–‡ä»¶æ§åˆ¶

ç¼–è¾‘ `config_3dspeaker.yaml`ï¼š

```yaml
speaker_verification:
  # ä¿®æ”¹è¿™é‡Œæ¥æ§åˆ¶é»˜è®¤æ˜¯å¦å¯ç”¨
  enabled: true   # true=å¯ç”¨, false=ç¦ç”¨
```

#### 4.3 Web UIä¸­åˆ‡æ¢

åœ¨Webç•Œé¢çš„"è¯­éŸ³è¯†åˆ«"æ ‡ç­¾é¡µï¼š
- å‹¾é€‰"å¯ç”¨è¯´è¯äººè¯†åˆ«"å¤é€‰æ¡† â†’ å¯ç”¨
- å–æ¶ˆå‹¾é€‰ â†’ ç¦ç”¨

---

## å‘½ä»¤è¡Œä½¿ç”¨

### å£°çº¹ç®¡ç†å‘½ä»¤

#### æ³¨å†Œå£°çº¹

```bash
# åŸºç¡€æ³¨å†Œ
python register_voiceprint.py \
  --action register \
  --speaker-id user001 \
  --speaker-name "å¼ ä¸‰" \
  --audio voice.wav

# æŒ‡å®šæ¨¡å‹ç±»å‹
python register_voiceprint.py \
  --action register \
  --speaker-id user001 \
  --speaker-name "å¼ ä¸‰" \
  --audio voice.wav \
  --model-type campplus

# ä½¿ç”¨CPU
python register_voiceprint.py \
  --action register \
  --speaker-id user001 \
  --speaker-name "å¼ ä¸‰" \
  --audio voice.wav \
  --device cpu
```

#### æ‰¹é‡æ³¨å†Œ

```bash
python register_voiceprint.py \
  --action batch-register \
  --audio-dir ./voice_samples \
  --pattern "*.wav"
```

#### è¯†åˆ«è¯´è¯äºº

```bash
python register_voiceprint.py \
  --action identify \
  --audio test.wav \
  --threshold 0.5
```

#### åˆ—å‡ºæ‰€æœ‰å£°çº¹

```bash
python register_voiceprint.py --action list
```

#### åˆ é™¤å£°çº¹

```bash
python register_voiceprint.py \
  --action unregister \
  --speaker-id user001
```

### é›†æˆè¯†åˆ«å‘½ä»¤

#### åŸºç¡€è¯­éŸ³è¯†åˆ«

```bash
# è‡ªåŠ¨è¯­è¨€è¯†åˆ«
python integrated_asr.py --audio test.wav

# æŒ‡å®šè¯­è¨€
python integrated_asr.py --audio test.wav --language zh

# ä¿å­˜ç»“æœ
python integrated_asr.py --audio test.wav --output result.json
```

#### å¯ç”¨è¯´è¯äººè¯†åˆ«

```bash
# åŸºç¡€ä½¿ç”¨
python integrated_asr.py --audio test.wav --enable-speaker

# è°ƒæ•´é˜ˆå€¼
python integrated_asr.py \
  --audio test.wav \
  --enable-speaker \
  --speaker-threshold 0.7

# æŒ‡å®šæ¨¡å‹
python integrated_asr.py \
  --audio test.wav \
  --enable-speaker \
  --speaker-model-type campplus
```

#### æ‰¹é‡å¤„ç†

```bash
# å¤„ç†å¤šä¸ªæ–‡ä»¶
python integrated_asr.py \
  --audio-list file1.wav file2.wav file3.wav \
  --enable-speaker \
  --output batch_results.json

# ä½¿ç”¨é€šé…ç¬¦ï¼ˆéœ€è¦shellæ”¯æŒï¼‰
python integrated_asr.py \
  --audio-list *.wav \
  --enable-speaker \
  --output results.json
```

#### é«˜çº§é€‰é¡¹

```bash
python integrated_asr.py \
  --audio test.wav \
  --enable-speaker \
  --language zh \
  --use-itn \
  --speaker-threshold 0.6 \
  --speaker-model-type eres2net \
  --device cuda:0 \
  --output result.json
```

### å®Œæ•´å‚æ•°åˆ—è¡¨

#### register_voiceprint.py å‚æ•°

| å‚æ•° | è¯´æ˜ | å¿…éœ€ | é»˜è®¤å€¼ |
|------|------|------|--------|
| `--action` | æ“ä½œç±»å‹ | æ˜¯ | - |
| `--speaker-id` | è¯´è¯äººID | éƒ¨åˆ† | - |
| `--speaker-name` | è¯´è¯äººåç§° | å¦ | speaker-id |
| `--audio` | éŸ³é¢‘è·¯å¾„ | éƒ¨åˆ† | - |
| `--audio-dir` | éŸ³é¢‘ç›®å½• | éƒ¨åˆ† | - |
| `--pattern` | æ–‡ä»¶æ¨¡å¼ | å¦ | `*.wav` |
| `--voiceprint-dir` | å£°çº¹åº“ç›®å½• | å¦ | `./voiceprint_db` |
| `--model-dir` | æ¨¡å‹ç›®å½• | å¦ | `./pretrained_models` |
| `--model-type` | æ¨¡å‹ç±»å‹ | å¦ | `eres2net` |
| `--device` | è®¡ç®—è®¾å¤‡ | å¦ | è‡ªåŠ¨é€‰æ‹© |
| `--threshold` | è¯†åˆ«é˜ˆå€¼ | å¦ | `0.5` |

action å¯é€‰å€¼ï¼š
- `register`: æ³¨å†Œå•ä¸ªå£°çº¹
- `batch-register`: æ‰¹é‡æ³¨å†Œ
- `unregister`: æ³¨é”€å£°çº¹
- `list`: åˆ—å‡ºæ‰€æœ‰å£°çº¹
- `identify`: è¯†åˆ«è¯´è¯äºº

#### integrated_asr.py å‚æ•°

| å‚æ•° | è¯´æ˜ | å¿…éœ€ | é»˜è®¤å€¼ |
|------|------|------|--------|
| `--audio` | éŸ³é¢‘æ–‡ä»¶ | éƒ¨åˆ† | - |
| `--audio-list` | éŸ³é¢‘åˆ—è¡¨ | éƒ¨åˆ† | - |
| `--enable-speaker` | å¯ç”¨è¯´è¯äººè¯†åˆ« | å¦ | False |
| `--voiceprint-dir` | å£°çº¹åº“ç›®å½• | å¦ | `./voiceprint_db` |
| `--speaker-model-dir` | æ¨¡å‹ç›®å½• | å¦ | `./pretrained_models` |
| `--speaker-model-type` | æ¨¡å‹ç±»å‹ | å¦ | `eres2net` |
| `--speaker-threshold` | è¯†åˆ«é˜ˆå€¼ | å¦ | `0.5` |
| `--sensevoice-model` | SenseVoiceæ¨¡å‹ | å¦ | `iic/SenseVoiceSmall` |
| `--vad-model` | VADæ¨¡å‹ | å¦ | `iic/speech_fsmn_vad_zh-cn-16k-common-pytorch` |
| `--language` | è¯­è¨€ | å¦ | `auto` |
| `--use-itn` | æ–‡æœ¬è§„èŒƒåŒ– | å¦ | True |
| `--device` | è®¡ç®—è®¾å¤‡ | å¦ | `cuda:0` |
| `--output` | è¾“å‡ºæ–‡ä»¶ | å¦ | - |
| `--show-info` | æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯ | å¦ | False |

---

## Web UIä½¿ç”¨

### å¯åŠ¨Webç•Œé¢

```bash
python webui_integrated.py
```

å¯åŠ¨åï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨æ‰“å¼€ http://localhost:7860

### ç•Œé¢åŠŸèƒ½ä»‹ç»

#### 1. è¯­éŸ³è¯†åˆ«æ ‡ç­¾é¡µ

**åŠŸèƒ½ï¼š** è¿›è¡Œè¯­éŸ³è¯†åˆ«ã€æƒ…æ„Ÿè¯†åˆ«å’Œäº‹ä»¶æ£€æµ‹

**ä½¿ç”¨æ­¥éª¤ï¼š**
1. ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶æˆ–ä½¿ç”¨éº¦å…‹é£å½•éŸ³
2. é€‰æ‹©è¯­è¨€ï¼ˆå»ºè®®autoï¼‰
3. é€‰æ‹©æ˜¯å¦å¯ç”¨è¯´è¯äººè¯†åˆ«
4. é€‰æ‹©æ˜¯å¦ä½¿ç”¨æ–‡æœ¬è§„èŒƒåŒ–
5. ç‚¹å‡»"å¼€å§‹è¯†åˆ«"æŒ‰é’®
6. æŸ¥çœ‹è¯†åˆ«ç»“æœå’Œè¯´è¯äººä¿¡æ¯

**ç•Œé¢å…ƒç´ ï¼š**
- éŸ³é¢‘è¾“å…¥ï¼šæ”¯æŒæ‹–æ‹½ä¸Šä¼ æˆ–ç‚¹å‡»ä¸Šä¼ 
- è¯­è¨€é€‰æ‹©ï¼šä¸‹æ‹‰èœå•
- è¯´è¯äººè¯†åˆ«å¼€å…³ï¼šå¤é€‰æ¡†
- æ–‡æœ¬è§„èŒƒåŒ–å¼€å…³ï¼šå¤é€‰æ¡†
- è¯†åˆ«æŒ‰é’®ï¼šå¼€å§‹å¤„ç†
- ç»“æœæ˜¾ç¤ºï¼šæ–‡æœ¬æ¡†æ˜¾ç¤ºç»“æœ

#### 2. å£°çº¹ç®¡ç†æ ‡ç­¾é¡µ

**åŠŸèƒ½ï¼š** æ³¨å†Œã€æŸ¥çœ‹å’Œåˆ é™¤è¯´è¯äººå£°çº¹

**æ³¨å†Œå£°çº¹ï¼š**
1. å¡«å†™è¯´è¯äººIDï¼ˆå¿…å¡«ï¼‰
2. å¡«å†™è¯´è¯äººåç§°ï¼ˆå¯é€‰ï¼‰
3. ä¸Šä¼ å£°çº¹éŸ³é¢‘
4. ç‚¹å‡»"æ³¨å†Œå£°çº¹"æŒ‰é’®
5. æŸ¥çœ‹æ³¨å†Œç»“æœ

**ç®¡ç†å£°çº¹ï¼š**
- ç‚¹å‡»"æŸ¥çœ‹æ‰€æœ‰å£°çº¹"æŒ‰é’®ï¼šåˆ—å‡ºæ‰€æœ‰å·²æ³¨å†Œçš„å£°çº¹
- å¡«å†™IDå¹¶ç‚¹å‡»"åˆ é™¤å£°çº¹"ï¼šåˆ é™¤æŒ‡å®šå£°çº¹

#### 3. ä½¿ç”¨è¯´æ˜æ ‡ç­¾é¡µ

**åŠŸèƒ½ï¼š** æŸ¥çœ‹å®Œæ•´çš„ä½¿ç”¨æ•™ç¨‹å’Œå¸¸è§é—®é¢˜

åŒ…å«ï¼š
- åŸºç¡€ä½¿ç”¨æ•™ç¨‹
- å‘½ä»¤è¡Œä½¿ç”¨è¯´æ˜
- é«˜çº§é…ç½®è¯´æ˜
- å¸¸è§é—®é¢˜è§£ç­”

### Web UIé…ç½®

ç¼–è¾‘ `config_3dspeaker.yaml` çš„ webui éƒ¨åˆ†ï¼š

```yaml
webui:
  port: 7860              # ç«¯å£å·
  server_name: "0.0.0.0"  # ç›‘å¬åœ°å€
  share: false            # æ˜¯å¦åˆ›å»ºå…¬å¼€é“¾æ¥
  theme: "soft"           # ç•Œé¢ä¸»é¢˜
  max_concurrent: 5       # æœ€å¤§å¹¶å‘æ•°
```

### è‡ªå®šä¹‰ä¸»é¢˜

æ”¯æŒçš„ä¸»é¢˜ï¼š
- `default`: é»˜è®¤ä¸»é¢˜
- `soft`: æŸ”å’Œä¸»é¢˜ï¼ˆæ¨èï¼‰
- `huggingface`: HuggingFaceä¸»é¢˜
- `grass`: è‰ç»¿ä¸»é¢˜
- `peach`: æ¡ƒçº¢ä¸»é¢˜

ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š
```yaml
webui:
  theme: "soft"  # ä¿®æ”¹è¿™é‡Œ
```

---

## é…ç½®æ–‡ä»¶è¯´æ˜

é…ç½®æ–‡ä»¶ï¼š`config_3dspeaker.yaml`

### å®Œæ•´é…ç½®ç¤ºä¾‹

```yaml
# è¯´è¯äººè¯†åˆ«é…ç½®
speaker_verification:
  enabled: false                                    # é»˜è®¤æ˜¯å¦å¯ç”¨
  voiceprint_dir: "./voiceprint_db"                # å£°çº¹åº“ç›®å½•
  model_dir: "./pretrained_models"                 # æ¨¡å‹ç›®å½•
  model_type: "eres2net"                           # æ¨¡å‹ç±»å‹
  threshold: 0.5                                   # è¯†åˆ«é˜ˆå€¼

# SenseVoiceé…ç½®
sensevoice:
  model: "iic/SenseVoiceSmall"                     # æ¨¡å‹åç§°
  vad_model: "iic/speech_fsmn_vad_zh-cn-16k-common-pytorch"
  use_itn: true                                    # æ–‡æœ¬è§„èŒƒåŒ–
  batch_size_s: 60                                 # æ‰¹å¤„ç†å¤§å°
  default_language: "auto"                         # é»˜è®¤è¯­è¨€

# ç³»ç»Ÿé…ç½®
system:
  device: "cuda:0"                                 # è®¡ç®—è®¾å¤‡
  log_level: "INFO"                                # æ—¥å¿—çº§åˆ«
  output_format: "json"                            # è¾“å‡ºæ ¼å¼

# Web UIé…ç½®
webui:
  port: 7860                                       # ç«¯å£
  server_name: "0.0.0.0"                          # åœ°å€
  share: false                                     # å…¬å¼€é“¾æ¥
  theme: "soft"                                    # ä¸»é¢˜
```

### é…ç½®é¡¹è¯¦è§£

#### speaker_verification é…ç½®

| é…ç½®é¡¹ | è¯´æ˜ | å¯é€‰å€¼ |
|-------|------|--------|
| `enabled` | é»˜è®¤å¯ç”¨çŠ¶æ€ | `true`, `false` |
| `voiceprint_dir` | å£°çº¹æ•°æ®åº“ç›®å½• | ä»»æ„è·¯å¾„ |
| `model_dir` | æ¨¡å‹ç¼“å­˜ç›®å½• | ä»»æ„è·¯å¾„ |
| `model_type` | æ¨¡å‹ç±»å‹ | `campplus`, `eres2net`, `eres2netv2` |
| `threshold` | è¯†åˆ«é˜ˆå€¼ | 0.0 - 1.0 |

#### sensevoice é…ç½®

| é…ç½®é¡¹ | è¯´æ˜ | å¯é€‰å€¼ |
|-------|------|--------|
| `model` | SenseVoiceæ¨¡å‹ | modelscopeæ¨¡å‹IDæˆ–æœ¬åœ°è·¯å¾„ |
| `vad_model` | VADæ¨¡å‹ | modelscopeæ¨¡å‹IDæˆ–æœ¬åœ°è·¯å¾„ |
| `use_itn` | æ–‡æœ¬è§„èŒƒåŒ– | `true`, `false` |
| `batch_size_s` | æ‰¹å¤„ç†å¤§å°ï¼ˆç§’ï¼‰ | æ­£æ•´æ•° |
| `default_language` | é»˜è®¤è¯­è¨€ | `auto`, `zh`, `en`, `yue`, `ja`, `ko` |

#### system é…ç½®

| é…ç½®é¡¹ | è¯´æ˜ | å¯é€‰å€¼ |
|-------|------|--------|
| `device` | è®¡ç®—è®¾å¤‡ | `cuda:0`, `cuda:1`, `cpu` |
| `log_level` | æ—¥å¿—çº§åˆ« | `DEBUG`, `INFO`, `WARNING`, `ERROR` |
| `output_format` | è¾“å‡ºæ ¼å¼ | `json`, `txt` |

---

## APIæ¥å£

### Python API

#### 1. åˆ›å»ºç³»ç»Ÿå®ä¾‹

```python
from integrated_asr import IntegratedASRSystem

# åŸºç¡€åˆ›å»º
system = IntegratedASRSystem()

# å¯ç”¨è¯´è¯äººè¯†åˆ«
system = IntegratedASRSystem(enable_speaker_verification=True)

# å®Œæ•´å‚æ•°
system = IntegratedASRSystem(
    enable_speaker_verification=True,
    voiceprint_dir="./voiceprint_db",
    speaker_model_dir="./pretrained_models",
    speaker_model_type="eres2net",
    speaker_threshold=0.5,
    sensevoice_model="iic/SenseVoiceSmall",
    vad_model="iic/speech_fsmn_vad_zh-cn-16k-common-pytorch",
    device="cuda:0"
)
```

#### 2. å¤„ç†å•ä¸ªéŸ³é¢‘

```python
# åŸºç¡€ä½¿ç”¨
result = system.process_audio("test.wav")

# æŒ‡å®šå‚æ•°
result = system.process_audio(
    audio_path="test.wav",
    language="zh",
    use_itn=True,
    identify_speaker=True
)

# ç»“æœç»“æ„
{
    'audio_path': 'test.wav',
    'speaker_info': {
        'speaker_id': 'user001',
        'speaker_name': 'å¼ ä¸‰',
        'similarity': 0.856
    },
    'asr_results': [
        {'text': 'è¿™æ˜¯è¯†åˆ«çš„æ–‡æœ¬ğŸ˜Š'}
    ],
    'processing_time': 1.23
}
```

#### 3. æ‰¹é‡å¤„ç†

```python
audio_list = ['file1.wav', 'file2.wav', 'file3.wav']

results = system.batch_process(
    audio_list=audio_list,
    language="auto",
    use_itn=True,
    output_file="results.json"
)
```

#### 4. åˆ‡æ¢åŠŸèƒ½

```python
# å¯ç”¨è¯´è¯äººè¯†åˆ«
system.toggle_speaker_verification(True)

# ç¦ç”¨è¯´è¯äººè¯†åˆ«
system.toggle_speaker_verification(False)
```

#### 5. è·å–ç³»ç»Ÿä¿¡æ¯

```python
info = system.get_system_info()
print(info)

# è¾“å‡ºç¤ºä¾‹
{
    'speaker_verification_enabled': True,
    'speaker_threshold': 0.5,
    'device': 'cuda:0',
    'registered_speakers_count': 3,
    'registered_speakers': ['user001', 'user002', 'user003']
}
```

### å£°çº¹ç®¡ç†API

```python
from register_voiceprint import VoiceprintManager

# åˆ›å»ºç®¡ç†å™¨
manager = VoiceprintManager(
    voiceprint_dir="./voiceprint_db",
    model_dir="./pretrained_models",
    model_type="eres2net"
)

# æ³¨å†Œå£°çº¹
success = manager.register_speaker(
    speaker_id="user001",
    audio_path="voice.wav",
    speaker_name="å¼ ä¸‰"
)

# è¯†åˆ«è¯´è¯äºº
result = manager.identify_speaker(
    audio_path="test.wav",
    threshold=0.5
)

# åˆ—å‡ºæ‰€æœ‰å£°çº¹
speakers = manager.list_speakers(verbose=True)

# åˆ é™¤å£°çº¹
manager.unregister_speaker("user001")

# æ‰¹é‡æ³¨å†Œ
manager.batch_register(
    audio_dir="./voice_samples",
    pattern="*.wav"
)
```

---

## å¸¸è§é—®é¢˜

### Q1: é¦–æ¬¡è¿è¡Œå¾ˆæ…¢ï¼Œæ€ä¹ˆåŠï¼Ÿ

**A:** é¦–æ¬¡è¿è¡Œéœ€è¦ä»ModelScopeä¸‹è½½æ¨¡å‹æ–‡ä»¶ï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
- è€å¿ƒç­‰å¾…ä¸‹è½½å®Œæˆ
- ä¸‹è½½åçš„æ¨¡å‹ä¼šç¼“å­˜ï¼Œåç»­ä½¿ç”¨ä¼šå¾ˆå¿«
- å¦‚æœä¸‹è½½å¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨ä¸‹è½½æ¨¡å‹ï¼š
  ```bash
  # è®¾ç½®ModelScopeç¼“å­˜ç›®å½•
  export MODELSCOPE_CACHE=~/.cache/modelscope
  
  # æ‰‹åŠ¨ä¸‹è½½æ¨¡å‹ï¼ˆå¯é€‰ï¼‰
  modelscope download --model iic/SenseVoiceSmall
  modelscope download --model iic/speech_eres2net_sv_zh-cn_16k-common
  ```

### Q2: è¯´è¯äººè¯†åˆ«å‡†ç¡®ç‡ä¸é«˜ï¼Ÿ

**A:** å¯èƒ½çš„åŸå› å’Œè§£å†³æ–¹æ¡ˆï¼š

**åŸå› 1: æ³¨å†ŒéŸ³é¢‘è´¨é‡å·®**
- âœ… ä½¿ç”¨3-10ç§’çº¯å‡€äººå£°
- âœ… åœ¨å®‰é™ç¯å¢ƒå½•åˆ¶
- âœ… é¿å…èƒŒæ™¯å™ªéŸ³

**åŸå› 2: æµ‹è¯•éŸ³é¢‘ä¸æ³¨å†ŒéŸ³é¢‘å·®å¼‚å¤§**
- âœ… ä½¿ç”¨ç›¸ä¼¼çš„å½•éŸ³è®¾å¤‡
- âœ… ä¿æŒç›¸ä¼¼çš„è¯´è¯æ–¹å¼
- âœ… é¿å…å£°éŸ³å¤±çœŸ

**åŸå› 3: é˜ˆå€¼è®¾ç½®ä¸å½“**
- âœ… è°ƒé«˜é˜ˆå€¼ï¼ˆå¦‚0.7ï¼‰æé«˜å‡†ç¡®ç‡
- âœ… è°ƒä½é˜ˆå€¼ï¼ˆå¦‚0.4ï¼‰æé«˜å¬å›ç‡

**åŸå› 4: æ¨¡å‹é€‰æ‹©**
- âœ… å°è¯•ä¸åŒçš„æ¨¡å‹ç±»å‹
- âœ… `eres2netv2` é€šå¸¸æ•ˆæœæœ€å¥½

### Q3: GPUå†…å­˜ä¸å¤Ÿæ€ä¹ˆåŠï¼Ÿ

**A:** æœ‰å‡ ç§è§£å†³æ–¹æ¡ˆï¼š

**æ–¹æ¡ˆ1: ä½¿ç”¨CPU**
```bash
python integrated_asr.py --audio test.wav --device cpu
```

**æ–¹æ¡ˆ2: ä¿®æ”¹é…ç½®æ–‡ä»¶**
```yaml
system:
  device: "cpu"
```

**æ–¹æ¡ˆ3: å‡å°‘æ‰¹å¤„ç†å¤§å°**
```yaml
sensevoice:
  batch_size_s: 30  # ä»60å‡å°‘åˆ°30
```

### Q4: æ”¯æŒå®æ—¶è¯†åˆ«å—ï¼Ÿ

**A:** å½“å‰ç‰ˆæœ¬ä¸»è¦æ”¯æŒç¦»çº¿éŸ³é¢‘æ–‡ä»¶å¤„ç†ã€‚å®æ—¶æµå¼è¯†åˆ«åŠŸèƒ½åœ¨å¼€å‘ä¸­ã€‚

### Q5: å¦‚ä½•æé«˜è¯†åˆ«é€Ÿåº¦ï¼Ÿ

**A:** ä¼˜åŒ–å»ºè®®ï¼š

1. **ä½¿ç”¨GPU**
   ```yaml
   system:
     device: "cuda:0"
   ```

2. **å…³é—­VAD**ï¼ˆå¯¹çŸ­éŸ³é¢‘ï¼‰
   ```python
   # ä¿®æ”¹ä»£ç ï¼Œä¸ä½¿ç”¨VADæ¨¡å‹
   system = IntegratedASRSystem(vad_model=None)
   ```

3. **ç¦ç”¨ä¸éœ€è¦çš„åŠŸèƒ½**
   ```python
   # ä¸éœ€è¦è¯´è¯äººè¯†åˆ«æ—¶å…³é—­
   system = IntegratedASRSystem(enable_speaker_verification=False)
   ```

4. **æ‰¹é‡å¤„ç†**
   ```python
   # æ‰¹é‡å¤„ç†æ¯”é€ä¸ªå¤„ç†å¿«
   system.batch_process(audio_list)
   ```

### Q6: å¦‚ä½•æ›´æ¢æ¨¡å‹ï¼Ÿ

**A:** ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š

```yaml
speaker_verification:
  model_type: "eres2netv2"  # æ›´æ¢è¯´è¯äººè¯†åˆ«æ¨¡å‹

sensevoice:
  model: "iic/SenseVoiceSmall"  # æ›´æ¢è¯­éŸ³è¯†åˆ«æ¨¡å‹
```

æ”¯æŒçš„è¯´è¯äººè¯†åˆ«æ¨¡å‹ï¼š
- `campplus`: CAM++æ¨¡å‹ï¼Œé€Ÿåº¦å¿«
- `eres2net`: ERes2Netæ¨¡å‹ï¼Œå¹³è¡¡
- `eres2netv2`: ERes2NetV2æ¨¡å‹ï¼Œæ•ˆæœæœ€å¥½ï¼ˆæ¨èï¼‰

### Q7: å£°çº¹åº“å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ

**A:** é»˜è®¤å­˜å‚¨åœ¨ `./voiceprint_db` ç›®å½•ï¼š

```
voiceprint_db/
  â”œâ”€â”€ embeddings/          # å£°çº¹ç‰¹å¾æ–‡ä»¶
  â”‚   â”œâ”€â”€ user001.npy
  â”‚   â””â”€â”€ user002.npy
  â””â”€â”€ metadata.json        # å…ƒæ•°æ®æ–‡ä»¶
```

å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æˆ–å‘½ä»¤è¡Œå‚æ•°æ›´æ”¹ç›®å½•ä½ç½®ã€‚

### Q8: å¦‚ä½•å¤‡ä»½å£°çº¹åº“ï¼Ÿ

**A:** ç›´æ¥å¤åˆ¶æ•´ä¸ª `voiceprint_db` ç›®å½•ï¼š

```bash
# å¤‡ä»½
cp -r voiceprint_db voiceprint_db_backup

# æ¢å¤
cp -r voiceprint_db_backup voiceprint_db
```

### Q9: ä¸åŒæœºå™¨çš„å£°çº¹åº“å¯ä»¥å…±äº«å—ï¼Ÿ

**A:** å¯ä»¥ï¼Œä½†éœ€è¦æ³¨æ„ï¼š

âœ… **å¯ä»¥å…±äº«çš„æƒ…å†µï¼š**
- ä½¿ç”¨ç›¸åŒçš„æ¨¡å‹ç±»å‹
- metadata.json å’Œ embeddings/ ç›®å½•å®Œæ•´

âŒ **ä¸èƒ½å…±äº«çš„æƒ…å†µï¼š**
- ä½¿ç”¨äº†ä¸åŒçš„æ¨¡å‹ç±»å‹
- æ¨¡å‹ç‰ˆæœ¬ä¸ä¸€è‡´

### Q10: å¦‚ä½•æ·»åŠ æ–°è¯­è¨€æ”¯æŒï¼Ÿ

**A:** SenseVoiceå·²æ”¯æŒä¸»æµè¯­è¨€ï¼Œå¦‚éœ€æ·»åŠ å…¶ä»–è¯­è¨€ï¼š

1. æŸ¥çœ‹SenseVoiceå®˜æ–¹æ–‡æ¡£
2. å¯èƒ½éœ€è¦å¾®è°ƒæ¨¡å‹
3. å‚è€ƒå®˜æ–¹å¾®è°ƒæ•™ç¨‹

---

## æ€§èƒ½ä¼˜åŒ–

### 1. ç¡¬ä»¶é€‰æ‹©

**æ¨èé…ç½®ï¼š**

| åœºæ™¯ | CPU | å†…å­˜ | GPU | æ€§èƒ½ |
|------|-----|------|-----|------|
| å¼€å‘æµ‹è¯• | 4æ ¸ | 8GB | - | æ…¢ |
| å°è§„æ¨¡éƒ¨ç½² | 8æ ¸ | 16GB | GTX 1060 | ä¸­ |
| ç”Ÿäº§ç¯å¢ƒ | 16æ ¸ | 32GB | RTX 3090 | å¿« |
| å¤§è§„æ¨¡éƒ¨ç½² | 32æ ¸ | 64GB | A100 | å¾ˆå¿« |

### 2. è½¯ä»¶ä¼˜åŒ–

#### ä¼˜åŒ–1: ä½¿ç”¨GPUåŠ é€Ÿ

```yaml
system:
  device: "cuda:0"
  use_gpu: true
```

**æ€§èƒ½æå‡ï¼š** 5-10å€

#### ä¼˜åŒ–2: è°ƒæ•´æ‰¹å¤„ç†å¤§å°

```yaml
sensevoice:
  batch_size_s: 60  # æ ¹æ®GPUæ˜¾å­˜è°ƒæ•´
```

- æ˜¾å­˜4GB: batch_size_s=30
- æ˜¾å­˜8GB: batch_size_s=60
- æ˜¾å­˜16GB+: batch_size_s=120

#### ä¼˜åŒ–3: é¢„åŠ è½½æ¨¡å‹

```python
# ç³»ç»Ÿå¯åŠ¨æ—¶é¢„åŠ è½½
system = IntegratedASRSystem(enable_speaker_verification=True)
system.speaker_manager.load_model()  # é¢„åŠ è½½

# åç»­ä½¿ç”¨æ›´å¿«
```

#### ä¼˜åŒ–4: éŸ³é¢‘é¢„å¤„ç†

```python
import torchaudio

# æå‰è½¬æ¢éŸ³é¢‘æ ¼å¼
wav, sr = torchaudio.load("input.mp3")
torchaudio.save("input.wav", wav, 16000)

# ä½¿ç”¨è½¬æ¢åçš„wavæ–‡ä»¶
result = system.process_audio("input.wav")
```

### 3. æ‰¹é‡å¤„ç†ä¼˜åŒ–

```python
# ä¸æ¨èï¼šé€ä¸ªå¤„ç†
for audio in audio_list:
    system.process_audio(audio)  # æ…¢

# æ¨èï¼šæ‰¹é‡å¤„ç†
system.batch_process(audio_list)  # å¿«
```

### 4. éƒ¨ç½²ä¼˜åŒ–

**æ–¹æ¡ˆ1: å®¹å™¨åŒ–éƒ¨ç½²**

```dockerfile
# Dockerfileç¤ºä¾‹
FROM pytorch/pytorch:2.0.0-cuda11.7-cudnn8-runtime

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .
CMD ["python", "webui_integrated.py"]
```

**æ–¹æ¡ˆ2: ä½¿ç”¨ONNXåŠ é€Ÿ**

```python
# å¯¼å‡ºONNXæ¨¡å‹ï¼ˆå¼€å‘ä¸­ï¼‰
# å¯ä»¥è·å¾—1.5-2å€åŠ é€Ÿ
```

---

## æŠ€æœ¯ç»†èŠ‚

### 1. ç³»ç»Ÿæ¶æ„

```
IntegratedASRSystem
â”œâ”€â”€ SpeakerManager (3D-Speaker)
â”‚   â”œâ”€â”€ æ¨¡å‹åŠ è½½
â”‚   â”œâ”€â”€ ç‰¹å¾æå–
â”‚   â”œâ”€â”€ å£°çº¹åŒ¹é…
â”‚   â””â”€â”€ æ•°æ®åº“ç®¡ç†
â””â”€â”€ SenseVoice
    â”œâ”€â”€ VADåˆ‡åˆ†
    â”œâ”€â”€ è¯­éŸ³è¯†åˆ«
    â”œâ”€â”€ æƒ…æ„Ÿè¯†åˆ«
    â””â”€â”€ äº‹ä»¶æ£€æµ‹
```

### 2. å¤„ç†æµç¨‹

```
è¾“å…¥éŸ³é¢‘
    â†“
[å¯é€‰] è¯´è¯äººè¯†åˆ«
    â”œâ†’ æå–å£°çº¹ç‰¹å¾
    â”œâ†’ ä¸æ•°æ®åº“åŒ¹é…
    â””â†’ è¿”å›è¯´è¯äººä¿¡æ¯
    â†“
è¯­éŸ³è¯†åˆ«
    â”œâ†’ VADåˆ‡åˆ†
    â”œâ†’ ç‰¹å¾æå–
    â”œâ†’ æ¨¡å‹æ¨ç†
    â””â†’ åå¤„ç†
    â†“
è¾“å‡ºç»“æœ
    â”œâ†’ è¯†åˆ«æ–‡æœ¬
    â”œâ†’ æƒ…æ„Ÿæ ‡ç­¾
    â”œâ†’ äº‹ä»¶æ ‡ç­¾
    â””â†’ è¯´è¯äººä¿¡æ¯
```

### 3. å£°çº¹ç‰¹å¾

**ç‰¹å¾ç»´åº¦ï¼š** 192ç»´ï¼ˆeres2netï¼‰

**æå–æ–¹æ³•ï¼š**
1. éŸ³é¢‘ â†’ FBankç‰¹å¾ (80ç»´)
2. FBank â†’ ERes2Net â†’ Embedding (192ç»´)
3. Embedding å½’ä¸€åŒ–
4. ä¿å­˜ä¸º .npy æ–‡ä»¶

**åŒ¹é…æ–¹æ³•ï¼š**
- ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—
- å…¬å¼: `similarity = (AÂ·B) / (||A||Â·||B||)`
- èŒƒå›´: [-1, 1]ï¼Œè¶Šæ¥è¿‘1è¶Šç›¸ä¼¼

### 4. æ¨¡å‹è¯¦æƒ…

#### 3D-Speakeræ¨¡å‹

| æ¨¡å‹ | å‚æ•°é‡ | ç‰¹å¾ç»´åº¦ | è®­ç»ƒæ•°æ® | é€‚ç”¨åœºæ™¯ |
|------|--------|----------|---------|---------|
| CAM++ | 7M | 192 | 20ä¸‡äºº | ä¸­æ–‡é€šç”¨ |
| ERes2Net | 6.6M | 192 | 20ä¸‡äºº | ä¸­æ–‡é€šç”¨ |
| ERes2NetV2 | 7.1M | 192 | 20ä¸‡äºº | ä¸­æ–‡é€šç”¨ï¼ˆæ¨èï¼‰ |

#### SenseVoiceæ¨¡å‹

| èƒ½åŠ› | è¯¦æƒ… |
|------|------|
| æ¨¡å‹å¤§å° | ~220M |
| å‚æ•°é‡ | ~220M |
| è¯­è¨€æ”¯æŒ | 5ç§ |
| æƒ…æ„Ÿç±»åˆ« | 7ç§ |
| äº‹ä»¶ç±»åˆ« | 8ç§ |
| æ¨ç†é€Ÿåº¦ | 10séŸ³é¢‘ 70ms |

### 5. æ•°æ®æ ¼å¼

#### å£°çº¹å…ƒæ•°æ® (metadata.json)

```json
{
  "user001": {
    "speaker_id": "user001",
    "speaker_name": "å¼ ä¸‰",
    "audio_path": "voice.wav",
    "embedding_file": "voiceprint_db/embeddings/user001.npy",
    "register_time": "2024-10-30T10:30:00",
    "model_type": "eres2net",
    "metadata": {}
  }
}
```

#### è¯†åˆ«ç»“æœ

```json
{
  "audio_path": "test.wav",
  "speaker_info": {
    "speaker_id": "user001",
    "speaker_name": "å¼ ä¸‰",
    "similarity": 0.856
  },
  "asr_results": [
    {"text": "è¿™æ˜¯è¯†åˆ«çš„æ–‡æœ¬ğŸ˜Š"}
  ],
  "processing_time": 1.23
}
```

---

## å®Œæ•´å·¥ä½œæµç¨‹ç¤ºä¾‹

### åœºæ™¯1: æ–°ç³»ç»Ÿé¦–æ¬¡ä½¿ç”¨

```bash
# 1. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 2. æ³¨å†Œç¬¬ä¸€ä¸ªè¯´è¯äºº
python register_voiceprint.py \
  --action register \
  --speaker-id user001 \
  --speaker-name "å¼ ä¸‰" \
  --audio voice_zhangsan.wav

# 3. æ³¨å†Œç¬¬äºŒä¸ªè¯´è¯äºº
python register_voiceprint.py \
  --action register \
  --speaker-id user002 \
  --speaker-name "æå››" \
  --audio voice_lisi.wav

# 4. æŸ¥çœ‹å·²æ³¨å†Œçš„å£°çº¹
python register_voiceprint.py --action list

# 5. æµ‹è¯•è¯†åˆ«ï¼ˆå¯ç”¨è¯´è¯äººè¯†åˆ«ï¼‰
python integrated_asr.py \
  --audio test.wav \
  --enable-speaker

# 6. å¯åŠ¨Webç•Œé¢
python webui_integrated.py
```

### åœºæ™¯2: æ‰¹é‡å¤„ç†ä¼šè®®å½•éŸ³

```bash
# 1. å‡†å¤‡éŸ³é¢‘æ–‡ä»¶
meeting_audio/
  â”œâ”€â”€ speaker1.wav    # ç”¨äºæ³¨å†Œ
  â”œâ”€â”€ speaker2.wav    # ç”¨äºæ³¨å†Œ
  â”œâ”€â”€ meeting.wav     # ä¼šè®®å½•éŸ³

# 2. æ‰¹é‡æ³¨å†Œå‚ä¼šäººå‘˜å£°çº¹
python register_voiceprint.py \
  --action batch-register \
  --audio-dir meeting_audio \
  --pattern "speaker*.wav"

# 3. å¤„ç†ä¼šè®®å½•éŸ³
python integrated_asr.py \
  --audio meeting_audio/meeting.wav \
  --enable-speaker \
  --language zh \
  --output meeting_result.json

# 4. æŸ¥çœ‹ç»“æœ
cat meeting_result.json
```

### åœºæ™¯3: Pythonè„šæœ¬é›†æˆ

```python
#!/usr/bin/env python3
from integrated_asr import IntegratedASRSystem
from register_voiceprint import VoiceprintManager
import json

# åˆå§‹åŒ–ç³»ç»Ÿ
system = IntegratedASRSystem(enable_speaker_verification=True)

# åœºæ™¯A: æ–°ç”¨æˆ·æ³¨å†Œ
def register_new_user(user_id, user_name, voice_file):
    manager = system.speaker_manager
    success = manager.register_speaker(
        speaker_id=user_id,
        audio_path=voice_file,
        speaker_name=user_name
    )
    return success

# åœºæ™¯B: è¯†åˆ«å¹¶å¤„ç†éŸ³é¢‘
def process_with_speaker_id(audio_file):
    result = system.process_audio(audio_file)
    
    if result['speaker_info']:
        speaker = result['speaker_info']['speaker_name']
        text = result['asr_results'][0]['text']
        print(f"{speaker}: {text}")
    else:
        text = result['asr_results'][0]['text']
        print(f"æœªçŸ¥è¯´è¯äºº: {text}")
    
    return result

# åœºæ™¯C: æ‰¹é‡å¤„ç†
def batch_process_directory(audio_dir):
    import os
    from pathlib import Path
    
    audio_files = list(Path(audio_dir).glob("*.wav"))
    results = system.batch_process(
        audio_list=[str(f) for f in audio_files],
        output_file="batch_results.json"
    )
    
    return results

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == '__main__':
    # æ³¨å†Œæ–°ç”¨æˆ·
    register_new_user("user001", "å¼ ä¸‰", "voice1.wav")
    
    # å¤„ç†å•ä¸ªéŸ³é¢‘
    result = process_with_speaker_id("test1.wav")
    
    # æ‰¹é‡å¤„ç†
    results = batch_process_directory("./audio_files")
```

---

## é¡¹ç›®æ–‡ä»¶è¯´æ˜

### æ ¸å¿ƒæ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ | ç”¨é€” |
|------|------|------|
| `register_voiceprint.py` | å£°çº¹æ³¨å†Œç®¡ç†è„šæœ¬ | æ³¨å†Œã€ç®¡ç†å£°çº¹ |
| `integrated_asr.py` | é›†æˆASRç³»ç»Ÿ | è¯­éŸ³è¯†åˆ«+è¯´è¯äººè¯†åˆ« |
| `webui_integrated.py` | Webç•Œé¢ | å›¾å½¢åŒ–æ“ä½œç•Œé¢ |
| `config_3dspeaker.yaml` | é…ç½®æ–‡ä»¶ | ç³»ç»Ÿé…ç½® |
| `README_3DSpeaker.md` | ä½¿ç”¨æ–‡æ¡£ | æœ¬æ–‡æ¡£ |

### ç›®å½•ç»“æ„

```
SenseVoice/
â”œâ”€â”€ register_voiceprint.py      # å£°çº¹ç®¡ç†è„šæœ¬
â”œâ”€â”€ integrated_asr.py            # é›†æˆç³»ç»Ÿ
â”œâ”€â”€ webui_integrated.py          # Webç•Œé¢
â”œâ”€â”€ config_3dspeaker.yaml        # é…ç½®æ–‡ä»¶
â”œâ”€â”€ README_3DSpeaker.md          # ä½¿ç”¨æ–‡æ¡£
â”œâ”€â”€ voiceprint_db/               # å£°çº¹æ•°æ®åº“
â”‚   â”œâ”€â”€ embeddings/              # å£°çº¹ç‰¹å¾
â”‚   â””â”€â”€ metadata.json            # å…ƒæ•°æ®
â”œâ”€â”€ pretrained_models/           # æ¨¡å‹ç¼“å­˜
â”‚   â””â”€â”€ ...
â”œâ”€â”€ speakerlab/                  # 3D-Speakerä»£ç 
â”‚   â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ process/
â”‚   â””â”€â”€ utils/
â””â”€â”€ requirements.txt             # ä¾èµ–åˆ—è¡¨
```

---

## æ›´æ–°æ—¥å¿—

### v1.0.0 (2024-10-30)

âœ¨ **æ–°åŠŸèƒ½ï¼š**
- âœ… é›†æˆ3D-Speakerå’ŒSenseVoice
- âœ… å£°çº¹æ³¨å†Œå’Œç®¡ç†åŠŸèƒ½
- âœ… è¯´è¯äººè¯†åˆ«åŠŸèƒ½
- âœ… å¯åˆ‡æ¢çš„åŠŸèƒ½å¼€å…³
- âœ… Web UIç•Œé¢
- âœ… å‘½ä»¤è¡Œå·¥å…·
- âœ… Python API
- âœ… é…ç½®æ–‡ä»¶æ”¯æŒ
- âœ… æ‰¹é‡å¤„ç†åŠŸèƒ½

ğŸ› **é—®é¢˜ä¿®å¤ï¼š**
- æ— 

ğŸ“ **æ–‡æ¡£ï¼š**
- âœ… å®Œæ•´çš„ä½¿ç”¨æ–‡æ¡£
- âœ… è¯¦ç»†çš„ç¤ºä¾‹ä»£ç 
- âœ… å¸¸è§é—®é¢˜è§£ç­”

---

## æŠ€æœ¯æ”¯æŒ

### é—®é¢˜åé¦ˆ

- **GitHub Issues**: åœ¨é¡¹ç›®é¡µé¢æäº¤é—®é¢˜
- **é’‰é’‰ç¾¤**: æ‰«æREADMEä¸­çš„äºŒç»´ç åŠ å…¥äº¤æµç¾¤

### å‚è€ƒèµ„æº

- [SenseVoice å®˜æ–¹æ–‡æ¡£](https://github.com/FunAudioLLM/SenseVoice)
- [3D-Speaker å®˜æ–¹æ–‡æ¡£](https://github.com/modelscope/3D-Speaker)
- [FunASR æ–‡æ¡£](https://github.com/modelscope/FunASR)
- [ModelScope å¹³å°](https://www.modelscope.cn/)

---

## è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ªåŸå§‹é¡¹ç›®çš„è®¸å¯è¯ï¼š
- SenseVoice: Apache License 2.0
- 3D-Speaker: Apache License 2.0

---

## è‡´è°¢

æ„Ÿè°¢ä»¥ä¸‹é¡¹ç›®ï¼š
- [SenseVoice](https://github.com/FunAudioLLM/SenseVoice) - è¯­éŸ³è¯†åˆ«æ¨¡å‹
- [3D-Speaker](https://github.com/modelscope/3D-Speaker) - è¯´è¯äººè¯†åˆ«æ¨¡å‹
- [FunASR](https://github.com/modelscope/FunASR) - è¯­éŸ³è¯†åˆ«å·¥å…·åŒ…
- [ModelScope](https://www.modelscope.cn/) - æ¨¡å‹ç¤¾åŒº

---

**æœ€åæ›´æ–°ï¼š** 2024-10-30
**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0.0

